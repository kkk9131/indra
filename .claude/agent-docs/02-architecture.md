# indra - アーキテクチャ設計

## 1. 全体構成

```
┌──────────────────┐    ┌──────────────────┐
│       CLI        │    │     Web UI       │
│  (Commander)     │    │   (Lit + Vite)   │
└────────┬─────────┘    └────────┬─────────┘
         │                       │
         │    WebSocket          │    WebSocket
         └───────────┬───────────┘
                     │
         ┌───────────▼───────────┐
         │       Gateway         │
         │   (Hono + ws)         │
         │  ・セッション管理      │
         │  ・プロトコル処理      │
         │  ・イベント配信        │
         └───────────┬───────────┘
                     │
         ┌───────────▼───────────┐
         │     Agent Core        │
         │  ・Claude Agent SDK   │
         │  ・ツール実行          │
         │  ・承認管理            │
         └───────────┬───────────┘
                     │
         ┌───────────▼───────────┐
         │   SNS Connectors      │
         │  ・X (Twitter)        │
         │  ・note               │
         └───────────────────────┘
```

## 1.5 SubagentRegistry層（実行状態管理）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Claude Agent SDK (query + agents + hooks)                 │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  agents: [                                                             │ │
│  │    { name: "x-operations-agent", skills: ["x-post-*", ...] },          │ │
│  │    { name: "note-writing-agent", skills: ["note-*", ...] },            │ │
│  │  ]                                                                     │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                           │                                                  │
│                           ▼                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                    Skills (ツールとして利用)                            │ │
│  │  .claude/skills/                                                       │ │
│  │  ├─ x-post-structure/    ├─ note-outline/ (将来)                       │ │
│  │  ├─ x-post-compose/      ├─ note-draft/ (将来)                         │ │
│  │  ├─ x-algorithm-evaluate/└─ note-publish/ (将来)                       │ │
│  │  └─ x-post-refine/                                                     │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────┬──────────────────────────────────────────┘
                                   │
        ┌──────────────────────────┼──────────────────────────┐
        ▼                          ▼                          ▼
┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐
│  x-operations/    │  │  note-writing/    │  │  future-agent/    │
│  ├─ agents.ts     │  │  ├─ agents.ts     │  │  (将来)           │
│  ├─ workflow.ts   │  │  ├─ workflow.ts   │  │                   │
│  └─ idempotency   │  │  └─ article-mgr   │  │                   │
└─────────┬─────────┘  └─────────┬─────────┘  └───────────────────┘
          └──────────────────────┴──────────────────┐
                                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         subagent/ (共通基盤)                                 │
│  RunRegistry │ Checkpoint │ SDK Hooks                                       │
└──────────────────────────────────┬──────────────────────────────────────────┘
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         永続化層 (data/runs/)                                │
│  {runId}.json - 「真実」の保存（SDKセッションは補助的）                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 設計原則

> SDKの`resume`機能は「会話コンテキストの復元」であり「タスク状態の復元」ではない。
> この混同は致命的。 — LLMディベート全員一致

- **SDKセッションは使い捨て可能**: 計算資源として扱う
- **真実は自分で保持**: 復旧可能な状態を `data/runs/` に永続化
- **チェックポイント**: タスク固有の進捗状態（phase, generatedPosts, publishedPostIds等）

## 2. WebSocketプロトコル

Clawdbotのプロトコル設計を参考:

### フレーム構造

```typescript
// リクエストフレーム（クライアント → サーバー）
type RequestFrame = {
  type: "req";
  id: string; // リクエストID（応答紐付け用）
  method: string; // "chat.send", "post.approve"等
  params?: unknown;
};

// レスポンスフレーム（サーバー → クライアント）
type ResponseFrame = {
  type: "res";
  id: string;
  ok: boolean;
  payload?: unknown;
  error?: { code: string; message: string };
};

// イベントフレーム（サーバー → クライアント、プッシュ通知）
type EventFrame = {
  type: "event";
  event: string; // "chat.message", "post.pending"等
  payload?: unknown;
  seq?: number; // シーケンス番号
};
```

### 主要メソッド

| カテゴリ | メソッド         | 説明             |
| -------- | ---------------- | ---------------- |
| chat     | `chat.send`      | メッセージ送信   |
| chat     | `chat.history`   | 履歴取得         |
| post     | `post.create`    | 投稿作成依頼     |
| post     | `post.approve`   | 投稿承認         |
| post     | `post.reject`    | 投稿却下         |
| schedule | `schedule.add`   | スケジュール追加 |
| schedule | `schedule.list`  | スケジュール一覧 |
| config   | `config.get/set` | 設定操作         |

## 3. セッション管理

### セッションキー形式

```
agent:<agentId>:<sessionId>
```

| 例                         | 意味                                     |
| -------------------------- | ---------------------------------------- |
| `agent:main:main`          | メインエージェントのデフォルトセッション |
| `agent:sns:twitter-thread` | SNS担当エージェントの特定タスク          |

### ファイル構造

```
~/.indra/
├── indra.json              # 設定ファイル
├── credentials/            # 認証情報（暗号化）
│   ├── anthropic.json
│   ├── openai.json
│   └── x.json
├── sessions/               # セッション永続化
│   └── agent-main/
│       ├── main.jsonl
│       └── task-1.jsonl
├── approval/               # 承認待ちキュー
│   └── pending/
└── agents/
    └── main/
        └── workspace/
```

## 4. 承認フローアーキテクチャ

```
┌─────────────────┐
│  Agent生成      │
│  (投稿コンテンツ)│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Approval Queue │  ← SQLite/ファイル永続化
│  (承認待ちリスト)│
└────────┬────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌───────┐ ┌───────┐
│  CLI  │ │Web UI │  ← どちらからでも承認可能
└───┬───┘ └───┬───┘
    │         │
    └────┬────┘
         ▼
┌─────────────────┐
│  承認/却下/編集  │
└────────┬────────┘
         │
         ▼ (承認時)
┌─────────────────┐
│  SNS Connector  │
│  (投稿実行)      │
└─────────────────┘
```
