# indra - 要件定義

## 1. 機能要件

### 1.1 機能一覧

| ID    | 機能               | 説明                                             | 優先度 |
| ----- | ------------------ | ------------------------------------------------ | ------ |
| F-001 | CLI基本操作        | エージェントへのメッセージ送信、設定管理         | 必須   |
| F-002 | Gateway            | WebSocketサーバー、セッション管理                | 必須   |
| F-003 | Web UI             | チャット画面、ダッシュボード                     | 必須   |
| F-004 | ニュース取得       | RSS/NewsAPI/SNSトレンドからの情報収集            | 高     |
| F-005 | レポート生成       | 収集情報の要約・レポート化                       | 高     |
| F-006 | SNS投稿作成        | X/note/YouTube/TikTok向けコンテンツ生成          | 高     |
| F-007 | 投稿承認フロー     | 生成内容の確認・編集・承認（レベル設定可）       | 高     |
| F-008 | Discord連携        | 双方向（通知送信＋コマンド受付）                 | 中     |
| F-009 | GitHub連携         | 双方向（通知送信＋コマンド受付＋プロダクト管理） | 中     |
| F-010 | 動画生成           | Remotionによるコードベース動画生成               | 中     |
| F-011 | 画像生成           | AI画像生成API連携                                | 中     |
| F-012 | ワークフロー基盤   | BaseWorkflow + subagent共通基盤による自動実行    | 最優先 |
| F-013 | スケジューラー     | cron式定時タスク実行                             | 最優先 |
| F-014 | ログ・分析         | 全操作＋外部連携のログ記録・分析                 | 横断   |
| F-015 | リサーチレポート   | トピック調査・構造化レポート生成                 | 高     |
| F-016 | 足場割付計算       | 寸法入力から割付計算                             | 低     |
| F-017 | 足場図面作図       | DXFファイル読み書き                              | 低     |
| F-018 | マルチエージェント | 複数エージェント同時実行・タスク分散             | 後期   |
| F-019 | プロアクティブ提案 | トレンド検知→行動提案→ワークフロー起動           | 後期   |
| F-020 | メモリ・学習       | 過去の結果から戦略を自動改善                     | 後期   |

### 1.2 ニュース/レポート要件

| ソース            | 取得方式     | 備考                    |
| ----------------- | ------------ | ----------------------- |
| RSS               | フィード購読 | 任意のRSSフィードに対応 |
| NewsAPI           | REST API     | APIキー必要             |
| Webスクレイピング | Playwright等 | サイト個別対応          |
| SNSトレンド       | X API v2     | トレンド/検索           |

### 1.3 SNS連携要件

| プラットフォーム | API                  | 機能                             |
| ---------------- | -------------------- | -------------------------------- |
| X (Twitter)      | X API v2             | ツイート投稿、スレッド作成       |
| note             | note API / Web自動化 | 記事投稿、下書き保存             |
| YouTube          | YouTube Data API v3  | 動画アップロード、メタデータ管理 |
| TikTok           | TikTok API           | ショート動画投稿                 |

クロスポスト: 1つのコンテンツを複数プラットフォームに最適化して同時投稿可能とする。

### 1.4 Discord/GitHub連携要件

| サービス | 入力（コマンド受付）      | 出力（通知）          |
| -------- | ------------------------- | --------------------- |
| Discord  | Botコマンド、メンション   | チャンネル通知、DM    |
| GitHub   | Issue/PRコメント、Webhook | Issue作成、PRコメント |

### 1.5 動画/画像生成要件

| 種別 | 技術                      | 備考                   |
| ---- | ------------------------- | ---------------------- |
| 動画 | Remotion                  | React/TypeScriptベース |
| 画像 | DALL-E / Stable Diffusion | API連携                |

### 1.6 足場機能要件

| 機能     | 入力        | 出力                    |
| -------- | ----------- | ----------------------- |
| 割付計算 | 寸法、条件  | 計算結果（テキスト/表） |
| 図面作図 | 計算結果    | DXFファイル             |
| 図面読込 | DXFファイル | 内部データ構造          |

### 1.7 承認フロー

```
エージェントがコンテンツを生成
        ↓
  承認キューに追加
        ↓
 CLI or Web UIで確認
        ↓
  承認 / 編集 / 却下
        ↓
    （承認時）実行
```

承認レベル（タスクごとに設定可能）:

- **auto**: 全自動（外部アクション含む承認不要）
- **approve-action**: 外部アクション（投稿等）の直前のみ承認
- **approve-all**: 全ステップで承認（デフォルト）

### 1.8 ワークフロー基盤要件

BaseWorkflow + subagent共通基盤パターン:

```
BaseWorkflow（共通ライフサイクル）
├── start / complete / fail（状態管理）
├── リトライ・エラー処理
├── 承認レベル判定（auto/approve-action/approve-all）
└── LLMProvider接続

各ドメインWorkflow extends BaseWorkflow
└── ドメイン固有ロジックのみ実装
```

- 各エージェントはBaseWorkflowを継承したTypeScriptクラスで定義
- 共通ライフサイクル（開始・完了・失敗・リトライ）はsubagent基盤が提供
- 承認レベルはワークフロー設定として統合
- エラーハンドリング・リトライは共通基盤で一元管理
- 実行ログ・状態永続化はCheckpointStoreで統一

### 1.9 スケジューラー要件

- cron式で定時タスク実行
- CLI: `indra schedule add/list/remove`
- ワークフロー定義と紐づけて自動実行
- 実行結果の通知（Web UI push、将来的にDiscord等）

## 2. 非機能要件

| ID     | 要件               | 仕様                                  |
| ------ | ------------------ | ------------------------------------- |
| NF-001 | データローカリティ | 全データを `~/.indra/` に保存         |
| NF-002 | 認証情報保護       | `~/.indra/credentials/` で暗号化保存  |
| NF-003 | 拡張性             | プラグイン機構でコネクター追加可能    |
| NF-004 | オフライン動作     | ローカルLLM使用時はネット不要         |
| NF-005 | マルチクライアント | CLI/Web UIが同一Gatewayに同時接続可能 |
| NF-006 | ログ完全性         | 全操作・外部連携を漏れなく記録        |

## 3. LLMプロバイダー要件

| プロバイダー | モデル例        | 接続方式         | 備考                                 |
| ------------ | --------------- | ---------------- | ------------------------------------ |
| Anthropic    | Claude 4 / Opus | Claude Agent SDK | メイン。ツール使用、エージェント機能 |
| Z.ai         | GLM-4           | REST API         | 補助。ログ深層分析等に使用           |

### 3.1 Claude Agent SDKの利点

- **ツール使用**: ファイル操作、コマンド実行、Web検索等
- **マルチターン**: 複雑なタスクの自律的な実行
- **コンテキスト管理**: 長いセッションの効率的な処理
- **サブエージェント**: 専門タスクの委譲

### 3.2 GLM連携

- ログ分析パイプライン（AnalyticsScheduler）で使用
- Claude Agent SDKとは独立したREST API呼び出し

## 4. ログ・分析要件

### 4.1 記録対象

| カテゴリ       | 内容                           |
| -------------- | ------------------------------ |
| Indra操作      | コマンド実行、エージェント会話 |
| SNS連携        | 投稿作成、承認、投稿結果       |
| Discord/GitHub | 送受信メッセージ、Webhook      |
| メディア生成   | 生成リクエスト、結果           |
| 外部API        | リクエスト/レスポンス（要約）  |

### 4.2 分析機能

- 操作履歴の検索・フィルタ
- 統計ダッシュボード
- 異常検知（エラー率、レスポンス遅延）
- 定期レポート生成
