# ハイブリッドサブエージェント設計 - メリット・デメリット分析

**作成日時**: 2026-02-01 23:15 JST
**対象**: `src/orchestrator/agents/subagent/` + `src/orchestrator/agents/x-operations/`

---

## 概要

Claude Agent SDK公式パターンをベースに、SubagentRegistry（実行状態追跡）を追加するハイブリッド設計。

**核心的な洞察**:

> SDKの`resume`機能は「会話コンテキストの復元」であり「タスク状態の復元」ではない。この混同は致命的。

---

## メリット

### 1. 復旧可能性（Recoverability）

| 項目               | 説明                                                                                           |
| ------------------ | ---------------------------------------------------------------------------------------------- |
| プロセス再起動耐性 | `data/runs/{runId}.json`に状態が永続化されるため、プロセス終了後も未完了タスクを検出・復旧可能 |
| チェックポイント   | タスク固有の進捗状態（phase, generatedPosts, publishedPostIds等）を任意のタイミングで保存      |
| 部分的成功の保持   | 途中で失敗しても、それまでの成果（生成済みポスト等）は保持される                               |

### 2. 冪等性（Idempotency）

| 項目         | 説明                                                           |
| ------------ | -------------------------------------------------------------- |
| 二重投稿防止 | `IdempotencyManager`により同じ記事への重複処理を防止           |
| 再試行安全性 | 失敗時はキーをクリアして再試行を許可、成功時は結果をキャッシュ |
| 外部API保護  | X APIへの重複リクエストを防ぎ、レート制限リスクを軽減          |

### 3. 可観測性（Observability）

| 項目             | 説明                                                 |
| ---------------- | ---------------------------------------------------- |
| ツール実行記録   | 全てのツール呼び出しがタイムスタンプ付きで記録される |
| 入力ダイジェスト | 同一入力の検出が可能（デバッグ・分析用）             |
| 状態遷移の追跡   | pending → running → completed/failed の遷移が明確    |

### 4. SDK非依存の状態管理

| 項目                    | 説明                                          |
| ----------------------- | --------------------------------------------- |
| SDKセッションは使い捨て | 計算資源として扱い、状態に依存しない          |
| バージョンアップ耐性    | SDK内部仕様変更の影響を受けにくい             |
| テスト容易性            | SDKをモックせずに状態管理ロジックをテスト可能 |

### 5. 拡張性

| 項目                   | 説明                                                     |
| ---------------------- | -------------------------------------------------------- |
| ドメイン別エージェント | `x-operations/`, `note-writing/`等のパターンで横展開可能 |
| 共通基盤の再利用       | `subagent/`の基盤コードを全エージェントで共有            |
| スキルのツール化       | `.claude/skills/`をエージェントのツールとして活用        |

---

## デメリット

### 1. 複雑性の増加

| 項目       | 説明                                                                             |
| ---------- | -------------------------------------------------------------------------------- |
| 学習コスト | SDK単体利用より概念が多い（RunRegistry, Checkpoint, Hooks）                      |
| コード量   | 約500行の追加コード（types, registry, checkpoint, hooks, workflow, idempotency） |
| デバッグ   | 問題発生時に確認すべきレイヤーが増える                                           |

### 2. 二重管理のリスク

| 項目         | 説明                                                |
| ------------ | --------------------------------------------------- |
| 状態の不整合 | SDK内部状態とSubagentRegistry状態の乖離が起こりうる |
| 同期の負荷   | フックで自動記録しているが、漏れる可能性あり        |
| メンテナンス | 両方を理解・維持する必要がある                      |

### 3. ストレージ依存

| 項目           | 説明                                           |
| -------------- | ---------------------------------------------- |
| ディスクI/O    | 各チェックポイントでJSONファイル書き込みが発生 |
| ファイル増加   | 長期運用で`data/runs/`にファイルが蓄積         |
| クリーンアップ | 古い実行記録の削除ロジックが未実装             |

### 4. 既存コードとの二重実装

| 項目                 | 説明                              |
| -------------------- | --------------------------------- |
| XPostWorkflowService | 既存実装が別途存在（SDK直接使用） |
| 移行コスト           | 既存コードからの移行が必要        |
| 並存期間             | 両方が動作する過渡期が発生        |

---

## トレードオフ分析

```
信頼性 ◀━━━━━━━━━━━━━━━━━━━━━━━▶ シンプルさ
        [ハイブリッド設計]  [SDK単体]
              ↑
          現在の選択
```

### 採用理由

1. **本番運用を想定**: X投稿は失敗時のリカバリが重要
2. **外部API連携**: 冪等性がないと二重投稿のリスク
3. **LLMディベート結論**: Gemini, Codex, GLM全員一致で推奨

### 不採用だった代替案

| 案                    | 理由                                           |
| --------------------- | ---------------------------------------------- |
| SDK単体               | 復旧不可、冪等性なし                           |
| 重厚な永続化（DB）    | オーバーエンジニアリング、ローカル運用に不向き |
| 外部キュー（Redis等） | 依存増加、セットアップコスト                   |

---

## 実装ファイル一覧

```
src/orchestrator/agents/
├── subagent/                   # 共通基盤
│   ├── types.ts                # SubagentRun, XPostCheckpoint
│   ├── checkpoint.ts           # CheckpointStore
│   ├── run-registry.ts         # RunRegistry
│   ├── hooks.ts                # SDK hooks統合
│   ├── index.ts                # 公開API
│   └── run-registry.test.ts    # テスト
│
└── x-operations/               # X運用エージェント
    ├── agents.ts               # サブエージェント定義
    ├── skills-loader.ts        # スキル読み込み
    ├── workflow.ts             # ワークフロー
    ├── idempotency.ts          # 冪等性管理
    ├── index.ts                # 公開API
    └── idempotency.test.ts     # テスト
```

---

## 今後の課題

| 優先度 | 課題                            | 対応案                             |
| ------ | ------------------------------- | ---------------------------------- |
| 高     | 既存workflow-service.tsとの統合 | 段階的移行、feature flag           |
| 中     | 古い実行記録のクリーンアップ    | TTL付き自動削除、手動purgeコマンド |
| 中     | エラーハンドリング強化          | リトライロジック、エスカレーション |
| 低     | メトリクス収集                  | 実行時間、成功率の集計             |

---

## 参考

- LLMディベート結果: 2026-02-01実施（Gemini, Codex, GLM）
- 設計ドキュメント: `.claude/agent-docs/02-architecture.md`
- ディレクトリ構成: `.claude/agent-docs/12-directory-structure.md`
